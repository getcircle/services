machine:
  environment:
    DJANGO_SETTINGS_MODULE: services.settings.test
  services:
    - docker

dependencies:
  cache_directories:
    - "wheelhouse/"
    - "~/docker/"
  override:
    # ensure cache directories exist
    - mkdir -p wheelhouse
    - mkdir -p ~/docker

    # workaround circleci not caching docker images
    - if [[ -e ~/docker/services-base.tar ]]; then docker load -i ~/docker/services-base.tar; fi
    - if [[ -e ~/docker/services-build.tar ]]; then docker load -i ~/docker/services-build.tar; fi
    - if [[ -e ~/docker/services.tar ]]; then docker load -i ~/docker/services.tar; fi
    - if [[ -e ~/docker/services-manage.tar ]]; then docker load -i ~/docker/services-manage.tar; fi

    # setup build images
    - docker build -t mhahn/services-base docker/base
    - docker build -t mhahn/services-build docker/build
    - docker run -v `pwd`/wheelhouse:/wheelhouse -v `pwd`:/application mhahn/services-build

    # setup run and manage images
    - docker build -t mhahn/services .
    - docker build -t mhahn/services-manage docker/manage

    # save docker images for circleci docker caching
    - docker save mhahn/services-base > ~/docker/services-base.tar
    - docker save mhahn/services-build > ~/docker/services-build.tar
    - docker save mhahn/services > ~/docker/services.tar
    - docker save mhahn/services-manage > ~/docker/services-manage.tar

    # TODO just use docker to run the tests
    - pip install --no-deps -r dev-requirements.txt

deployment:
  hub:
    branch: master
    commands:
      - docker tag mhahn/services-manage mhahn/services-manage:$CIRCLE_SHA1
      - docker tag mhahn/services mhahn/services:$CIRCLE_SHA1
      - docker tag mhahn/services mhahn/services:$CIRCLE_BRANCH
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push mhahn/services
      - docker push mhahn/services-manage
