machine:
  environment:
    DJANGO_SETTINGS_MODULE: services.settings.test
  services:
    - docker

dependencies:
  cache_directories:
    - "wheelhouse/"
  override:
    # ensure cache directories exist
    - mkdir -p wheelhouse

    # setup build images
    - docker build -t mhahn/services-base docker/base
    - docker build -t mhahn/services-build docker/build
    - docker run -v `pwd`/wheelhouse:/wheelhouse -v `pwd`:/application mhahn/services-build

    # setup run and manage images
    - docker build -t mhahn/services .
    - docker build -t mhahn/services-manage docker/manage

    # TODO just use docker to run the tests
    - pip install --no-deps -r dev-requirements.txt

deployment:
  hub:
    branch: master
    commands:
      - docker tag mhahn/services mhahn/services:$CIRCLE_SHA1
      - docker tag mhahn/services mhahn/services:$CIRCLE_BRANCH
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push mhahn/services
